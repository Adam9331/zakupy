<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista Zakup√≥w AI - GPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    ü§ñ Lista Zakup√≥w AI (GPT-4)
                </h1>
                <p class="text-gray-600">Inteligentne przetwarzanie przepis√≥w z makrosk≈Çadnikami</p>
            </div>

            <div id="apiSetup" class="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
                <h3 class="font-bold text-blue-800 mb-3">üîë Konfiguracja OpenAI API</h3>
                <p class="text-sm text-blue-700 mb-3">Potrzebujesz klucza API z OpenAI. <a href="https://platform.openai.com/api-keys" target="_blank" class="underline">Utw√≥rz klucz tutaj</a></p>
                <input 
                    type="password" 
                    id="apiKey" 
                    placeholder="sk-..." 
                    class="w-full p-3 border-2 border-blue-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-400"
                >
                <button onclick="saveApiKey()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg">
                    üíæ Zapisz Klucz API
                </button>
            </div>

            <div class="mb-6">
                <label for="imageInput" id="uploadLabel" class="block w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-6 px-6 rounded-xl text-center cursor-pointer shadow-lg opacity-50">
                    <div class="text-4xl mb-2">üì∏</div>
                    <span id="uploadText">Wgraj Screenshot(y) (Najpierw ustaw API Key)</span>
                    <p class="text-sm mt-2 opacity-80">‚ú® Mo≈ºesz wybraƒá wiele plik√≥w naraz!</p>
                </label>
                <input type="file" id="imageInput" accept="image/*" class="hidden" disabled multiple>
            </div>

            <!-- Queue Progress -->
            <div id="queueProgress" class="hidden mb-4 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold text-indigo-800">üì• Kolejka przetwarzania</span>
                    <span class="text-indigo-600 font-bold" id="queueStatus">0 / 0</span>
                </div>
                <div class="w-full bg-indigo-200 rounded-full h-3 overflow-hidden">
                    <div id="queueBar" class="bg-indigo-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-sm text-indigo-600 mt-2" id="queueInfo">Przetwarzanie...</p>
            </div>

            <div id="recipesCounter" class="hidden mb-4 p-3 bg-green-50 border-2 border-green-200 rounded-lg text-center">
                <p class="text-green-700 font-bold">
                    ‚úÖ Dodano <span id="totalRecipes">0</span> przepis√≥w!
                </p>
            </div>

            <button onclick="loadDemo()" class="w-full bg-gradient-to-r from-blue-400 to-cyan-500 text-white font-bold py-4 rounded-xl mb-6 shadow-lg">
                üç≥ Demo
            </button>

            <!-- Favorites Toggle -->
            <div class="flex gap-3 mb-6">
                <button 
                    id="btnRecipes" 
                    onclick="showRecipes()" 
                    class="flex-1 bg-purple-500 text-white font-bold py-3 rounded-xl transition-all"
                >
                    üìã Przepisy (<span id="recipesTabCount">0</span>)
                </button>
                <button 
                    id="btnFavorites" 
                    onclick="showFavorites()" 
                    class="flex-1 bg-gray-300 text-gray-700 font-bold py-3 rounded-xl transition-all"
                >
                    ‚≠ê Ulubione (<span id="favoritesTabCount">0</span>)
                </button>
            </div>

            <!-- Search & Filter (for favorites) -->
            <div id="favoritesSearch" class="hidden mb-4 space-y-3">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="üîç Szukaj przepisu lub #hashtag..." 
                    class="w-full p-3 border-2 border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                    oninput="filterFavorites()"
                >
                <div id="hashtagsContainer" class="flex flex-wrap gap-2"></div>
            </div>

            <div id="progress" class="hidden mb-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl">
                <div class="flex flex-col items-center gap-4">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent"></div>
                    <p id="progressText" class="text-blue-700 font-bold text-lg text-center"></p>
                </div>
            </div>

            <div id="error" class="hidden mb-6 p-4 bg-red-50 border-2 border-red-200 rounded-xl">
                <p class="text-red-700 font-bold">‚ö†Ô∏è B≈ÇƒÖd</p>
                <p id="errorText" class="text-red-600 text-sm mt-2"></p>
            </div>

            <div class="mb-6">
                <div class="flex gap-3 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex-1">üìã Przepisy (<span id="recipeCount">0</span>)</h2>
                    <button onclick="clearAllRecipes()" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-lg text-sm">
                        üóëÔ∏è Wyczy≈õƒá
                    </button>
                </div>
                <div id="recipesList" class="space-y-3"></div>
            </div>

            <button id="generateBtn" onclick="generateShoppingList()" disabled class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl mb-6 shadow-lg disabled:opacity-50">
                üõí Wygeneruj Listƒô Zakup√≥w
            </button>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Lista Zakup√≥w -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">üõí Lista Zakup√≥w</h2>
                        <button 
                            id="copyBtn" 
                            onclick="copyShoppingList()" 
                            class="hidden bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-all"
                        >
                            <span id="copyIcon">üìã</span>
                            <span id="copyText">Kopiuj</span>
                        </button>
                    </div>
                    <div id="shoppingList" class="bg-gray-50 rounded-xl p-4 min-h-32">
                        <p class="text-center text-gray-400 py-8">Wybierz przepisy</p>
                    </div>
                </div>

                <!-- Suma Makrosk≈Çadnik√≥w -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Suma Makrosk≈Çadnik√≥w</h2>
                    <div id="macrosSummary" class="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-xl p-4 min-h-32">
                        <p class="text-center text-gray-400 py-8">Wygeneruj listƒô</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let recipes = [];
        let selectedRecipes = new Set();
        let shoppingList = [];
        let apiKey = localStorage.getItem('openai_api_key') || '';
        let recipeIdCounter = 1;
        let isProcessing = false;
        let processingQueue = [];
        let favorites = JSON.parse(localStorage.getItem('favorite_recipes') || '[]');
        let showingFavorites = false;

        if (apiKey) {
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('apiSetup').classList.add('hidden');
            enableUpload();
        }

        function enableUpload() {
            const input = document.getElementById('imageInput');
            const label = document.getElementById('uploadLabel');
            const text = document.getElementById('uploadText');
            
            input.disabled = false;
            label.classList.remove('opacity-50');
            label.classList.add('hover:opacity-90');
            text.textContent = 'üì∏ Wgraj Screenshot(y)';
        }

        function saveApiKey() {
            apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey.startsWith('sk-')) {
                alert('Klucz API powinien zaczynaƒá siƒô od "sk-"');
                return;
            }
            localStorage.setItem('openai_api_key', apiKey);
            document.getElementById('apiSetup').classList.add('hidden');
            enableUpload();
            alert('‚úÖ Klucz zapisany!');
        }

        document.getElementById('imageInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            
            if (!apiKey) {
                showError('Najpierw ustaw klucz API!');
                return;
            }

            // Dodaj wszystkie pliki do kolejki
            console.log(`Dodano ${files.length} plik√≥w do kolejki`);
            processingQueue = files;
            
            // Poka≈º progress bar
            document.getElementById('queueProgress').classList.remove('hidden');
            updateQueueProgress(0, files.length);
            
            // Rozpocznij przetwarzanie kolejki
            processQueue();
        });

        async function processQueue() {
            if (isProcessing || processingQueue.length === 0) return;
            
            isProcessing = true;
            const totalFiles = processingQueue.length;
            let currentIndex = 0;

            while (processingQueue.length > 0) {
                const file = processingQueue.shift();
                currentIndex++;
                
                updateQueueProgress(currentIndex, totalFiles + (processingQueue.length > 0 ? processingQueue.length : 0));
                document.getElementById('queueInfo').textContent = `Przetwarzanie: ${file.name}`;
                
                try {
                    await processImage(file);
                    
                    // Kr√≥tka przerwa miƒôdzy przetwarzaniem (≈ºeby nie przekroczyƒá limit√≥w API)
                    if (processingQueue.length > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                } catch (error) {
                    console.error(`B≈ÇƒÖd przetwarzania ${file.name}:`, error);
                    // Kontynuuj mimo b≈Çƒôdu
                }
            }

            // Ukryj progress bar
            setTimeout(() => {
                document.getElementById('queueProgress').classList.add('hidden');
            }, 2000);

            isProcessing = false;
            document.getElementById('imageInput').value = '';
            
            // Poka≈º podsumowanie
            document.getElementById('recipesCounter').classList.remove('hidden');
            document.getElementById('totalRecipes').textContent = recipes.length;
            setTimeout(() => {
                document.getElementById('recipesCounter').classList.add('hidden');
            }, 5000);
        }

        function updateQueueProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            document.getElementById('queueBar').style.width = percentage + '%';
            document.getElementById('queueStatus').textContent = `${current} / ${total}`;
        }

        function showProgress(text) {
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('progressText').textContent = text;
            document.getElementById('error').classList.add('hidden');
        }

        function hideProgress() {
            document.getElementById('progress').classList.add('hidden');
        }

        function showError(text) {
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorText').textContent = text;
            hideProgress();
        }

        async function processImage(file) {
            showProgress('üì∏ Wczytywanie...');

            try {
                showProgress('üîç OCR...');
                
                const { data: { text } } = await Tesseract.recognize(file, 'pol+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            showProgress(`üîç OCR: ${Math.round(m.progress * 100)}% - ${file.name}`);
                        }
                    }
                });

                if (!text || text.trim().length < 10) {
                    console.warn(`OCR nie rozpozna≈Ç tekstu w: ${file.name}`);
                    showError(`‚ö†Ô∏è Pominiƒôto: ${file.name} (brak tekstu)`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    hideProgress();
                    return;
                }

                console.log(`OCR [${file.name}]:`, text.substring(0, 100) + '...');
                showProgress('ü§ñ GPT analizuje...');
                await processWithGPT(text, file.name);

            } catch (error) {
                console.error(`B≈ÇƒÖd [${file.name}]:`, error);
                showError(`‚ùå B≈ÇƒÖd: ${file.name}`);
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }

        async function processWithGPT(ocrText, filename = '') {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{
                            role: 'system',
                            content: 'Jeste≈õ asystentem kulinarnym. WyciƒÖgnij sk≈Çadniki, makrosk≈Çadniki i kalorie. Zwr√≥ƒá JSON.'
                        }, {
                            role: 'user',
                            content: `Z tekstu OCR wyciƒÖgnij:
1. Tytu≈Ç przepisu
2. Sk≈Çadniki
3. Makrosk≈Çadniki (bia≈Çko, wƒôglowodany, t≈Çuszcze, kalorie)

Tekst OCR:
${ocrText}

WA≈ªNE o makrosk≈Çadnikach:
- Szukaj: "bia≈Çko", "b:", "b", "protein"
- Szukaj: "wƒôglowodany", "wƒôgle", "w:", "w", "carbs"  
- Szukaj: "t≈Çuszcze", "t≈Çuszcz", "t:", "t", "fat"
- Szukaj: "kalorie", "kcal", "cal"
- Skr√≥ty: "500kcal, 40b, 14t, 57w" = 500 kcal, 40g bia≈Çka, 14g t≈Çuszczu, 57g wƒôgli
- Je≈õli brak w tek≈õcie, zwr√≥ƒá null

Zwr√≥ƒá JSON:
{
  "title": "nazwa",
  "ingredients": ["sk≈Çadnik 1", "sk≈Çadnik 2"],
  "macros": {
    "calories": 500,
    "protein": 40,
    "carbs": 57,
    "fat": 14
  }
}

Lub je≈õli brak makro:
{
  "title": "nazwa",
  "ingredients": [...],
  "macros": null
}`
                        }],
                        temperature: 0.3,
                        max_tokens: 1500
                    })
                });

                if (!response.ok) {
                    throw new Error('B≈ÇƒÖd API');
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();

                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Brak JSON');

                const result = JSON.parse(jsonMatch[0]);

                if (!result.ingredients?.length) {
                    console.warn(`Brak sk≈Çadnik√≥w w: ${filename}`);
                    return;
                }

                const newRecipe = {
                    id: recipeIdCounter++,
                    title: result.title || filename || `Przepis ${recipeIdCounter}`,
                    ingredients: result.ingredients,
                    macros: result.macros
                };
                
                recipes.push(newRecipe);
                selectedRecipes.add(newRecipe.id);
                
                hideProgress();
                renderRecipes();
        document.getElementById('favoritesTabCount').textContent = favorites.length;

            } catch (error) {
                console.error(`GPT error [${filename}]:`, error);
                throw error;
            }
        }

        function renderRecipes() {
            const container = document.getElementById('recipesList');
            document.getElementById('recipeCount').textContent = recipes.length;

            if (!recipes.length) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Brak przepis√≥w</p>';
                return;
            }

            container.innerHTML = recipes.map(r => `
                <div onclick="toggleRecipe(${r.id})" class="p-4 rounded-xl border-2 cursor-pointer transition-all ${
                    selectedRecipes.has(r.id) ? 'border-purple-500 bg-purple-50 shadow-lg' : 'border-gray-200 bg-white'
                }">
                    <div class="flex justify-between mb-2">
                        <h3 class="font-bold text-gray-800 flex-1">${r.title}</h3>
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                            selectedRecipes.has(r.id) ? 'bg-purple-500 border-purple-500 text-white' : 'border-gray-300'
                        }">${selectedRecipes.has(r.id) ? '‚úì' : ''}</div>
                    </div>
                    <p class="text-sm text-gray-600">üìã ${r.ingredients.length} sk≈Çadnik√≥w</p>
                    ${r.macros ? `
                        <div class="mt-3 pt-3 border-t grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-orange-100 p-2 rounded">
                                <span class="font-bold text-orange-700">üî• ${r.macros.calories || 0} kcal</span>
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <span class="font-bold text-blue-700">üí™ ${r.macros.protein || 0}g B</span>
                            </div>
                            <div class="bg-green-100 p-2 rounded">
                                <span class="font-bold text-green-700">üçû ${r.macros.carbs || 0}g W</span>
                            </div>
                            <div class="bg-yellow-100 p-2 rounded">
                                <span class="font-bold text-yellow-700">üßà ${r.macros.fat || 0}g T</span>
                            </div>
                        </div>
                    ` : '<p class="text-xs text-gray-400 mt-2">Brak makrosk≈Çadnik√≥w</p>'}
                </div>
            `).join('');

            document.getElementById('generateBtn').disabled = !selectedRecipes.size;
        }

        function toggleRecipe(id) {
            if (selectedRecipes.has(id)) {
                selectedRecipes.delete(id);
            } else {
                selectedRecipes.add(id);
            }
            renderRecipes();
        }

        function generateShoppingList() {
            const map = new Map();

            recipes.filter(r => selectedRecipes.has(r.id)).forEach(r => {
                r.ingredients.forEach(ing => {
                    const norm = ing.toLowerCase().trim();
                    let found = false;
                    
                    for (let [key, count] of map.entries()) {
                        const base1 = key.toLowerCase().replace(/\d+\s*(g|ml|kg|szt)/gi, '').trim();
                        const base2 = norm.replace(/\d+\s*(g|ml|kg|szt)/gi, '').trim();
                        
                        if (base1 === base2 || base1.includes(base2) || base2.includes(base1)) {
                            map.set(key, count + 1);
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found) map.set(ing, 1);
                });
            });

            shoppingList = Array.from(map.entries()).map(([name, count], i) => ({
                id: i,
                name: count > 1 ? `${name} (x${count})` : name,
                checked: false
            }));

            renderShoppingList();
            renderMacrosSummary();
        }

        function renderShoppingList() {
            const container = document.getElementById('shoppingList');
            const copyBtn = document.getElementById('copyBtn');

            if (!shoppingList.length) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Wybierz przepisy</p>';
                copyBtn.classList.add('hidden');
                return;
            }

            // Poka≈º przycisk kopiowania
            copyBtn.classList.remove('hidden');

            const left = shoppingList.filter(i => !i.checked).length;

            container.innerHTML = `
                <div class="space-y-2">
                    ${shoppingList.map(item => `
                        <div class="flex items-center gap-3 p-3 rounded-lg ${
                            item.checked ? 'bg-green-100 text-green-800 line-through' : 'bg-white'
                        } shadow-md">
                            <button onclick="toggleItem(${item.id})" class="w-6 h-6 rounded border-2 flex items-center justify-center ${
                                item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-gray-400'
                            }">${item.checked ? '‚úì' : ''}</button>
                            <span class="flex-1">${item.name}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 pt-4 border-t-2 text-center font-bold">
                    üõí ${left} / ${shoppingList.length} do kupienia
                </div>
            `;
        }

        async function copyShoppingList() {
            try {
                // Przygotuj tekst do skopiowania
                let text = 'üõí LISTA ZAKUP√ìW\n';
                text += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                // Dodaj wszystkie sk≈Çadniki (niezaznaczone na g√≥rze)
                const unchecked = shoppingList.filter(i => !i.checked);
                const checked = shoppingList.filter(i => i.checked);
                
                if (unchecked.length > 0) {
                    text += 'üìã DO KUPIENIA:\n';
                    unchecked.forEach((item, i) => {
                        text += `${i + 1}. ${item.name}\n`;
                    });
                    text += '\n';
                }
                
                if (checked.length > 0) {
                    text += '‚úÖ KUPIONE:\n';
                    checked.forEach((item, i) => {
                        text += `${i + 1}. ${item.name}\n`;
                    });
                    text += '\n';
                }
                
                // Dodaj podsumowanie
                text += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                text += `Razem: ${shoppingList.length} produkt√≥w\n`;
                text += `Do kupienia: ${unchecked.length}\n`;
                text += `Kupione: ${checked.length}\n\n`;
                
                // Dodaj makrosk≈Çadniki je≈õli sƒÖ
                const total = { calories: 0, protein: 0, carbs: 0, fat: 0 };
                let hasAny = false;

                recipes.filter(r => selectedRecipes.has(r.id)).forEach(r => {
                    if (r.macros) {
                        hasAny = true;
                        total.calories += r.macros.calories || 0;
                        total.protein += r.macros.protein || 0;
                        total.carbs += r.macros.carbs || 0;
                        total.fat += r.macros.fat || 0;
                    }
                });

                if (hasAny) {
                    text += 'üìä MAKROSK≈ÅADNIKI (RAZEM):\n';
                    text += `üî• Kalorie: ${total.calories} kcal\n`;
                    text += `üí™ Bia≈Çko: ${total.protein}g\n`;
                    text += `üçû Wƒôglowodany: ${total.carbs}g\n`;
                    text += `üßà T≈Çuszcze: ${total.fat}g\n\n`;
                }
                
                text += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                text += `Wygenerowano: ${new Date().toLocaleDateString('pl-PL')} ${new Date().toLocaleTimeString('pl-PL')}\n`;
                text += 'Lista Zakup√≥w AI ü§ñ\n';
                
                // Skopiuj do schowka
                await navigator.clipboard.writeText(text);
                
                // Animacja przycisku
                const copyIcon = document.getElementById('copyIcon');
                const copyText = document.getElementById('copyText');
                const copyBtn = document.getElementById('copyBtn');
                
                copyIcon.textContent = '‚úÖ';
                copyText.textContent = 'Skopiowano!';
                copyBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                copyBtn.classList.add('bg-green-500');
                
                // Przywr√≥ƒá po 2 sekundach
                setTimeout(() => {
                    copyIcon.textContent = 'üìã';
                    copyText.textContent = 'Kopiuj';
                    copyBtn.classList.remove('bg-green-500');
                    copyBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                }, 2000);
                
            } catch (error) {
                console.error('B≈ÇƒÖd kopiowania:', error);
                alert('‚ùå Nie uda≈Ço siƒô skopiowaƒá. Spr√≥buj ponownie.');
            }
        }

        function renderMacrosSummary() {
            const container = document.getElementById('macrosSummary');
            
            const total = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            let hasAny = false;

            recipes.filter(r => selectedRecipes.has(r.id)).forEach(r => {
                if (r.macros) {
                    hasAny = true;
                    total.calories += r.macros.calories || 0;
                    total.protein += r.macros.protein || 0;
                    total.carbs += r.macros.carbs || 0;
                    total.fat += r.macros.fat || 0;
                }
            });

            if (!hasAny) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Brak danych o makrosk≈Çadnikach</p>';
                return;
            }

            container.innerHTML = `
                <div class="space-y-3">
                    <div class="bg-gradient-to-r from-orange-400 to-red-400 text-white p-4 rounded-xl">
                        <div class="text-center">
                            <div class="text-5xl font-bold">${total.calories}</div>
                            <div class="text-sm opacity-90 mt-1">KALORII RAZEM</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-blue-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-700">${total.protein}g</div>
                            <div class="text-xs text-blue-600 mt-1">üí™ Bia≈Çko</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-700">${total.carbs}g</div>
                            <div class="text-xs text-green-600 mt-1">üçû Wƒôgle</div>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-700">${total.fat}g</div>
                            <div class="text-xs text-yellow-600 mt-1">üßà T≈Çuszcz</div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-500 text-center mt-3">
                        Suma z ${recipes.filter(r => selectedRecipes.has(r.id)).length} zaznaczonych przepis√≥w
                    </div>
                </div>
            `;
        }

        function toggleItem(id) {
            const item = shoppingList.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                renderShoppingList();
            }
        }

        function toggleFavorite(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const existingIndex = favorites.findIndex(f => f.title === recipe.title);
            
            if (existingIndex >= 0) {
                // Usu≈Ñ z ulubionych
                favorites.splice(existingIndex, 1);
            } else {
                // Dodaj do ulubionych - poka≈º dialog z nazwƒÖ i hashtagami
                const name = prompt('Nazwa przepisu:', recipe.title);
                if (!name) return;
                
                const tags = prompt('Dodaj hashtagi (oddziel spacjami):\nPrzyk≈Çad: #≈õniadanie #fit #szybkie', '');
                const hashtagsArray = tags ? tags.match(/#\w+/g) || [] : [];
                
                favorites.push({
                    title: name,
                    ingredients: recipe.ingredients,
                    macros: recipe.macros,
                    hashtags: hashtagsArray,
                    savedAt: new Date().toISOString()
                });
            }
            
            saveFavorites();
            renderRecipes();
            if (showingFavorites) renderFavorites();
        }

        function saveFavorites() {
            localStorage.setItem('favorite_recipes', JSON.stringify(favorites));
            document.getElementById('favoritesTabCount').textContent = favorites.length;
        }

        function showRecipes() {
            showingFavorites = false;
            document.getElementById('btnRecipes').classList.remove('bg-gray-300', 'text-gray-700');
            document.getElementById('btnRecipes').classList.add('bg-purple-500', 'text-white');
            document.getElementById('btnFavorites').classList.remove('bg-purple-500', 'text-white');
            document.getElementById('btnFavorites').classList.add('bg-gray-300', 'text-gray-700');
            document.getElementById('favoritesSearch').classList.add('hidden');
            renderRecipes();
        }

        function showFavorites() {
            showingFavorites = true;
            document.getElementById('btnFavorites').classList.remove('bg-gray-300', 'text-gray-700');
            document.getElementById('btnFavorites').classList.add('bg-purple-500', 'text-white');
            document.getElementById('btnRecipes').classList.remove('bg-purple-500', 'text-white');
            document.getElementById('btnRecipes').classList.add('bg-gray-300', 'text-gray-700');
            document.getElementById('favoritesSearch').classList.remove('hidden');
            renderFavorites();
            renderHashtagFilter();
        }

        function renderFavorites(filtered = null) {
            const container = document.getElementById('recipesList');
            const list = filtered || favorites;

            if (!list.length) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Brak ulubionych przepis√≥w<br><small class="text-xs">Kliknij ‚ù§Ô∏è przy przepisie aby dodaƒá do ulubionych</small></p>';
                return;
            }

            container.innerHTML = list.map((fav, index) => `
                <div class="p-4 rounded-xl border-2 border-pink-200 bg-gradient-to-r from-pink-50 to-purple-50 mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${fav.title}</h3>
                            ${fav.hashtags?.length ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${fav.hashtags.map(tag => `
                                        <span class="text-xs bg-purple-200 text-purple-700 px-2 py-1 rounded-full">${tag}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <button 
                                onclick="editFavorite(${favorites.indexOf(fav)})" 
                                class="text-blue-500 hover:text-blue-700 text-xl"
                                title="Edytuj"
                            >‚úèÔ∏è</button>
                            <button 
                                onclick="deleteFavorite(${favorites.indexOf(fav)})" 
                                class="text-red-500 hover:text-red-700 text-xl"
                                title="Usu≈Ñ"
                            >üóëÔ∏è</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">üìã ${fav.ingredients.length} sk≈Çadnik√≥w</p>
                    ${fav.macros ? `
                        <div class="grid grid-cols-4 gap-2 text-xs mb-3">
                            <div class="bg-orange-100 p-2 rounded text-center">
                                <span class="font-bold text-orange-700">${fav.macros.calories || 0}</span>
                                <div class="text-xs text-orange-600">kcal</div>
                            </div>
                            <div class="bg-blue-100 p-2 rounded text-center">
                                <span class="font-bold text-blue-700">${fav.macros.protein || 0}g</span>
                                <div class="text-xs text-blue-600">B</div>
                            </div>
                            <div class="bg-green-100 p-2 rounded text-center">
                                <span class="font-bold text-green-700">${fav.macros.carbs || 0}g</span>
                                <div class="text-xs text-green-600">W</div>
                            </div>
                            <div class="bg-yellow-100 p-2 rounded text-center">
                                <span class="font-bold text-yellow-700">${fav.macros.fat || 0}g</span>
                                <div class="text-xs text-yellow-600">T</div>
                            </div>
                        </div>
                    ` : ''}
                    <button 
                        onclick="addFavoriteToRecipes(${favorites.indexOf(fav)})" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition-all"
                    >
                        ‚ûï Dodaj do przepis√≥w
                    </button>
                </div>
            `).join('');
        }

        function renderHashtagFilter() {
            const allTags = new Set();
            favorites.forEach(fav => {
                if (fav.hashtags) {
                    fav.hashtags.forEach(tag => allTags.add(tag));
                }
            });

            const container = document.getElementById('hashtagsContainer');
            if (allTags.size === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400">Brak hashtag√≥w</p>';
                return;
            }

            container.innerHTML = Array.from(allTags).map(tag => `
                <button 
                    onclick="filterByHashtag('${tag}')" 
                    class="bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1 rounded-full transition-all"
                >
                    ${tag}
                </button>
            `).join('');
        }

        function filterFavorites() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                renderFavorites();
                return;
            }

            const filtered = favorites.filter(fav => {
                const titleMatch = fav.title.toLowerCase().includes(query);
                const tagMatch = fav.hashtags?.some(tag => tag.toLowerCase().includes(query));
                return titleMatch || tagMatch;
            });

            renderFavorites(filtered);
        }

        function filterByHashtag(hashtag) {
            document.getElementById('searchInput').value = hashtag;
            filterFavorites();
        }

        function addFavoriteToRecipes(index) {
            const fav = favorites[index];
            const newRecipe = {
                id: recipeIdCounter++,
                title: fav.title,
                ingredients: fav.ingredients,
                macros: fav.macros
            };
            
            recipes.push(newRecipe);
            selectedRecipes.add(newRecipe.id);
            
            // Prze≈ÇƒÖcz na zak≈Çadkƒô przepis√≥w
            showRecipes();
            
            // Poka≈º komunikat
            alert(`‚úÖ "${fav.title}" dodany do przepis√≥w!`);
        }

        function editFavorite(index) {
            const fav = favorites[index];
            const newName = prompt('Nowa nazwa:', fav.title);
            if (newName) {
                fav.title = newName;
            }
            
            const newTags = prompt('Hashtagi (oddziel spacjami):', (fav.hashtags || []).join(' '));
            if (newTags !== null) {
                fav.hashtags = newTags.match(/#\w+/g) || [];
            }
            
            saveFavorites();
            renderFavorites();
            renderHashtagFilter();
        }

        function deleteFavorite(index) {
            if (confirm(`UsunƒÖƒá "${favorites[index].title}" z ulubionych?`)) {
                favorites.splice(index, 1);
                saveFavorites();
                renderFavorites();
                renderHashtagFilter();
                renderRecipes(); // Update heart icons
            }
        }

        function clearAllRecipes() {
            if (!confirm('UsunƒÖƒá wszystko?')) return;
            recipes = [];
            selectedRecipes.clear();
            shoppingList = [];
            recipeIdCounter = 1;
            renderRecipes();
            renderShoppingList();
            renderMacrosSummary();
        }

        function loadDemo() {
            recipes = [
                {
                    id: 1,
                    title: "Spaghetti Bolognese",
                    ingredients: ["spaghetti 500g", "miƒôso 300g", "pomidory 400g"],
                    macros: { calories: 650, protein: 35, carbs: 75, fat: 18 }
                },
                {
                    id: 2,
                    title: "Kurczak curry",
                    ingredients: ["kurczak 600g", "ry≈º 300g", "mleko kokosowe 400ml"],
                    macros: { calories: 520, protein: 45, carbs: 52, fat: 12 }
                }
            ];
            selectedRecipes.clear();
            recipes.forEach(r => selectedRecipes.add(r.id));
            renderRecipes();
        }

        renderRecipes();
    </script>
</body>
</html>
