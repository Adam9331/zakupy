<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista Zakup√≥w AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxS26DGBLPz24OF0V9fZ-99RGQA41hJtE",
            authDomain: "lista-zakupow-3f33b.firebaseapp.com",
            projectId: "lista-zakupow-3f33b",
            storageBucket: "lista-zakupow-3f33b.firebasestorage.app",
            messagingSenderId: "556246362684",
            appId: "1:556246362684:web:e3a17e4a330cc979e83139"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const CATEGORIES = [
            { id: "sniadania",         label: "≈öniadania",         emoji: "üåÖ", color: "from-amber-400 to-orange-500",   light: "bg-amber-50 border-amber-200" },
            { id: "drugie_sniadania",  label: "Drugie ≈öniadania",  emoji: "ü•™", color: "from-lime-400 to-green-500",    light: "bg-lime-50 border-lime-200" },
            { id: "obiady",            label: "Obiady",            emoji: "üç≤", color: "from-blue-400 to-indigo-500",   light: "bg-blue-50 border-blue-200" },
            { id: "kolacje",           label: "Kolacje",           emoji: "üåô", color: "from-purple-400 to-pink-500",   light: "bg-purple-50 border-purple-200" },
            { id: "dodatkowy_posilek", label: "Dodatkowy Posi≈Çek", emoji: "üçé", color: "from-rose-400 to-red-500",      light: "bg-rose-50 border-rose-200" },
        ];

        let cart = [];
        let currentCategory = null;
        let categoryRecipes = [];
        let localSelected = new Set();
        let customKcal = {};
        let isProcessing = false;
        let processingQueue = [];
        let recipeIdCounter = 1;

        // ‚îÄ‚îÄ LICZNIK KALORII ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let dailyLimit = parseInt(localStorage.getItem('dailyKcalLimit') || '2500');

        function getCartKcal() {
            return cart.reduce((sum, r) => sum + (r.macros?.calories || 0), 0);
        }

        function getRemaining() {
            return dailyLimit - getCartKcal();
        }

        function getProgressPct() {
            return Math.min(100, Math.round((getCartKcal() / dailyLimit) * 100));
        }

        function getProgressColor() {
            const pct = getProgressPct();
            if (pct >= 100) return { bar: 'bg-red-500', text: 'text-red-600', bg: 'bg-red-50 border-red-300' };
            if (pct >= 80)  return { bar: 'bg-orange-400', text: 'text-orange-600', bg: 'bg-orange-50 border-orange-300' };
            return { bar: 'bg-green-500', text: 'text-green-600', bg: 'bg-green-50 border-green-300' };
        }

        function renderKcalCounter() {
            const used = getCartKcal();
            const remaining = getRemaining();
            const pct = getProgressPct();
            const col = getProgressColor();
            const over = remaining < 0;

            return `
            <div class="mb-5 p-4 ${col.bg} border-2 rounded-2xl">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üî•</span>
                        <div>
                            <p class="font-black text-gray-800 text-base">Licznik Kalorii</p>
                            <p class="text-xs text-gray-500">Limit dzienny: <button onclick="window.changeDailyLimit()" class="font-bold underline hover:no-underline ${col.text}">${dailyLimit} kcal</button></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-black ${col.text}">${over ? '+' + Math.abs(remaining) : remaining}</p>
                        <p class="text-xs text-gray-500">${over ? 'kcal ponad limit' : 'kcal pozosta≈Ço'}</p>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-2">
                    <div class="${col.bar} h-4 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                </div>

                <div class="flex justify-between text-xs text-gray-500">
                    <span>Zjedzone: <span class="font-bold ${col.text}">${used} kcal</span></span>
                    <span>${pct}% dziennego limitu</span>
                    <span>Limit: <span class="font-bold">${dailyLimit} kcal</span></span>
                </div>

                ${over ? `<div class="mt-2 text-xs font-bold text-red-600 bg-red-100 px-3 py-1.5 rounded-lg text-center">‚ö†Ô∏è Przekroczono limit o ${Math.abs(remaining)} kcal!</div>` : ''}
                ${cart.length > 0 ? `
                <div class="mt-2 pt-2 border-t border-gray-200 space-y-1">
                    ${cart.map(r => {
                        const cat = CATEGORIES.find(c => c.id === r.categoryId);
                        const kcal = r.macros?.calories || 0;
                        if (!kcal) return '';
                        return `<div class="flex justify-between text-xs text-gray-600">
                            <span>${cat?.emoji} ${r.title}${r._scaled ? ' ‚ö°' : ''}</span>
                            <span class="font-bold">${kcal} kcal</span>
                        </div>`;
                    }).filter(Boolean).join('')}
                </div>` : ''}
            </div>`;
        }

        window.changeDailyLimit = function() {
            const input = prompt('Podaj dzienny limit kalorii:', dailyLimit);
            if (input === null) return;
            const val = parseInt(input);
            if (isNaN(val) || val <= 0) { alert('Podaj prawid≈ÇowƒÖ liczbƒô!'); return; }
            dailyLimit = val;
            localStorage.setItem('dailyKcalLimit', val);
            renderHome();
        };

        // ‚îÄ‚îÄ SKALOWANIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function scaleRecipe(recipe, targetKcal) {
            if (!recipe.macros?.calories || recipe.macros.calories === 0) return recipe;
            const ratio = targetKcal / recipe.macros.calories;
            const scaledIngredients = recipe.ingredients.map(ing =>
                ing.replace(/(\d+(?:[.,]\d+)?)/g, (match) => {
                    const num = parseFloat(match.replace(',', '.'));
                    const scaled = Math.round(num * ratio * 10) / 10;
                    return String(scaled).replace('.', ',');
                })
            );
            return {
                ...recipe,
                ingredients: scaledIngredients,
                macros: {
                    calories: Math.round(recipe.macros.calories * ratio),
                    protein:  Math.round((recipe.macros.protein  || 0) * ratio * 10) / 10,
                    carbs:    Math.round((recipe.macros.carbs    || 0) * ratio * 10) / 10,
                    fat:      Math.round((recipe.macros.fat      || 0) * ratio * 10) / 10,
                },
                _scaled: true,
                _originalKcal: recipe.macros.calories,
                _targetKcal: targetKcal,
                _ratio: ratio
            };
        }

        // ‚îÄ‚îÄ HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderHome() {
            currentCategory = null;
            categoryRecipes = [];
            localSelected = new Set();
            customKcal = {};

            document.getElementById("app").innerHTML = `
                <div class="max-w-2xl mx-auto p-4 pb-10">
                    <div class="text-center mb-5 pt-5">
                        <div class="text-4xl mb-1">üõí</div>
                        <h1 class="text-3xl font-black text-gray-800 tracking-tight">Lista Zakup√≥w AI</h1>
                        <p class="text-gray-500 mt-1 text-sm">Wybierz przepisy z kategorii, potem wygeneruj listƒô</p>
                    </div>

                    <!-- LICZNIK KALORII -->
                    ${renderKcalCounter()}

                    <!-- KOSZYK -->
                    <div id="cartBanner" class="${cart.length ? '' : 'hidden'} mb-5 p-4 bg-green-50 border-2 border-green-300 rounded-2xl">
                        <div class="flex items-center justify-between mb-2">
                            <p class="font-black text-green-800">üß∫ Koszyk: ${cart.length} przepis√≥w</p>
                            <div class="flex gap-2">
                                <button onclick="window.clearCart()" class="bg-red-100 hover:bg-red-200 text-red-600 font-bold px-3 py-1.5 rounded-lg text-sm">üóëÔ∏è Wyczy≈õƒá</button>
                                <button onclick="window.goToResults()" class="bg-green-500 hover:bg-green-600 text-white font-bold px-3 py-1.5 rounded-lg text-sm">Generuj ‚Üí</button>
                            </div>
                        </div>
                        <p class="text-xs text-green-600 mb-2">${getCartSummary()}</p>
                        <div class="space-y-1">
                            ${cart.map(r => {
                                const cat = CATEGORIES.find(c => c.id === r.categoryId);
                                const kcalInfo = r._scaled ? ` <span class="text-orange-500 font-bold">(‚ö°${r._targetKcal} kcal)</span>` : (r.macros?.calories ? ` <span class="text-gray-400">(${r.macros.calories} kcal)</span>` : '');
                                return `<div class="flex items-center justify-between text-sm py-0.5">
                                    <span class="text-green-700">${cat?.emoji || ''} <span class="font-semibold">${r.title}</span>${kcalInfo}</span>
                                    <button onclick="window.removeFromCart('${r.firebaseId}')" class="text-red-400 hover:text-red-600 text-xs ml-2 font-bold">‚úï</button>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>

                    <!-- KATEGORIE -->
                    <div class="grid grid-cols-1 gap-3 mb-5">
                        ${CATEGORIES.map(cat => {
                            const inCart = cart.filter(r => r.categoryId === cat.id).length;
                            const catKcal = cart.filter(r => r.categoryId === cat.id).reduce((s,r) => s+(r.macros?.calories||0),0);
                            return `<button onclick="window.openCategory('${cat.id}')"
                                class="group relative overflow-hidden bg-gradient-to-r ${cat.color} text-white font-bold py-5 px-6 rounded-2xl shadow-md hover:scale-[1.02] active:scale-[0.98] transition-all duration-150 text-left">
                                <div class="flex items-center gap-4">
                                    <span class="text-3xl">${cat.emoji}</span>
                                    <div class="flex-1">
                                        <div class="text-lg font-black">${cat.label}</div>
                                        <div class="text-xs opacity-75 font-normal" id="count-${cat.id}">≈Åadowanie...</div>
                                    </div>
                                    ${inCart > 0 ? `<div class="bg-white text-green-600 font-black text-xs px-2 py-1 rounded-full text-center"><div>${inCart} ‚úì</div><div>${catKcal} kcal</div></div>` : ''}
                                </div>
                                <div class="absolute right-5 top-1/2 -translate-y-1/2 text-3xl opacity-30 group-hover:opacity-60 transition-opacity">‚Ä∫</div>
                            </button>`;
                        }).join('')}
                    </div>

                    ${cart.length ? `
                    <button onclick="window.goToResults()"
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black py-5 rounded-2xl shadow-xl text-lg hover:opacity-90 transition-all">
                        üõí Generuj listƒô zakup√≥w (${cart.length} przepis√≥w ¬∑ ${getCartKcal()} kcal)
                    </button>` : `
                    <div class="text-center text-gray-400 py-6 border-2 border-dashed border-gray-200 rounded-2xl">
                        <p class="text-sm">Wejd≈∫ w kategoriƒô ‚Üí zaznacz przepisy ‚Üí dodaj do koszyka</p>
                    </div>`}
                </div>
            `;
            CATEGORIES.forEach(cat => loadCategoryCount(cat));
        }

        async function loadCategoryCount(cat) {
            try {
                const q = query(collection(db, "recipes"), where("category", "==", cat.id));
                const snap = await getDocs(q);
                const el = document.getElementById("count-" + cat.id);
                if (el) el.textContent = snap.size + " przepis√≥w w bazie";
            } catch(e) {
                const el = document.getElementById("count-" + cat.id);
                if (el) el.textContent = "b≈ÇƒÖd";
            }
        }

        function getCartSummary() {
            if (!cart.length) return '';
            const byCat = {};
            cart.forEach(r => {
                const cat = CATEGORIES.find(c => c.id === r.categoryId);
                const label = cat ? cat.label : r.categoryId;
                byCat[label] = (byCat[label] || 0) + 1;
            });
            return Object.entries(byCat).map(([k,v]) => k + ": " + v).join(' ¬∑ ');
        }

        // ‚îÄ‚îÄ KOSZYK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.clearCart = function() { if (confirm("Wyczy≈õciƒá koszyk?")) { cart = []; renderHome(); } };
        window.removeFromCart = function(id) { cart = cart.filter(r => r.firebaseId !== id); renderHome(); };
        function isInCart(id) { return cart.some(r => r.firebaseId === id); }

        function updateCategoryCartBadge() {
            const el = document.getElementById("cartBadge");
            if (!el) return;
            const count = cart.length;
            const kcal = getCartKcal();
            el.textContent = count > 0 ? "üß∫ " + count + " ¬∑ " + kcal + " kcal" : "üß∫ Koszyk pusty";
            el.className = count > 0
                ? "text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full"
                : "text-sm font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full";
        }

        // Mini licznik w widoku kategorii
        function renderMiniCounter() {
            const used = getCartKcal();
            const remaining = getRemaining();
            const pct = getProgressPct();
            const col = getProgressColor();
            const over = remaining < 0;
            const el = document.getElementById("miniCounter");
            if (!el) return;
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="${col.bar} h-2 rounded-full transition-all duration-500" style="width:${pct}%"></div>
                        </div>
                    </div>
                    <div class="text-xs font-bold ${col.text} whitespace-nowrap">
                        üî• ${used}/${dailyLimit} kcal
                        ${over ? '<span class="text-red-500"> ‚ö†Ô∏è</span>' : ''}
                    </div>
                </div>
            `;
        }

        // ‚îÄ‚îÄ DOSTOSUJ KCAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.adjustKcal = function(firebaseId, event) {
            event.stopPropagation();
            const recipe = categoryRecipes.find(r => r.firebaseId === firebaseId);
            if (!recipe) return;
            if (!recipe.macros?.calories) { alert("Brak danych o kaloriach ‚Äî nie mo≈ºna skalowaƒá."); return; }

            const currentKcal = customKcal[firebaseId] || recipe.macros.calories;
            const remaining = getRemaining();
            const suggestion = isInCart(firebaseId)
                ? Math.max(50, currentKcal + remaining)
                : Math.max(50, currentKcal + remaining);

            const input = prompt(
                `‚ö° Dostosuj kalorie:\n"${recipe.title}"\n\nOrygina≈Ç: ${recipe.macros.calories} kcal\nAktualnie: ${currentKcal} kcal\nPozosta≈Ço w limicie: ${remaining} kcal\n\nPodaj docelowe kalorie:`,
                customKcal[firebaseId] || recipe.macros.calories
            );
            if (input === null) return;
            const targetKcal = parseInt(input);
            if (isNaN(targetKcal) || targetKcal <= 0) { alert("Podaj prawid≈ÇowƒÖ liczbƒô!"); return; }

            if (targetKcal === recipe.macros.calories) delete customKcal[firebaseId];
            else customKcal[firebaseId] = targetKcal;

            if (isInCart(firebaseId)) {
                const idx = cart.findIndex(r => r.firebaseId === firebaseId);
                if (idx >= 0) {
                    const scaled = scaleRecipe(recipe, targetKcal);
                    cart[idx] = { ...scaled, categoryId: currentCategory.id };
                }
            }
            renderCategoryRecipes();
            updateCategoryCartBadge();
            renderMiniCounter();
        };

        // ‚îÄ‚îÄ WIDOK KATEGORII ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.openCategory = async function(categoryId) {
            currentCategory = CATEGORIES.find(c => c.id === categoryId);
            categoryRecipes = [];
            localSelected = new Set();
            customKcal = {};

            document.getElementById("app").innerHTML = `
                <div class="max-w-2xl mx-auto p-4 pb-28">
                    <div class="flex items-center gap-3 mb-3 pt-4">
                        <button onclick="window.goHome()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold px-4 py-2 rounded-xl text-sm">‚Üê Wr√≥ƒá</button>
                        <div class="flex-1">
                            <h2 class="text-xl font-black text-gray-800">${currentCategory.emoji} ${currentCategory.label}</h2>
                        </div>
                        <span id="cartBadge" class="text-sm font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full">üß∫ Koszyk pusty</span>
                    </div>

                    <!-- Mini licznik kalorii -->
                    <div id="miniCounter" class="mb-4 p-3 bg-white border border-gray-200 rounded-xl shadow-sm"></div>

                    <div class="mb-4">
                        <label for="imageInput" class="block w-full bg-gradient-to-r ${currentCategory.color} text-white font-bold py-4 px-6 rounded-xl text-center cursor-pointer shadow-md hover:opacity-90 transition-all">
                            <span class="text-xl mr-2">üì∏</span> Dodaj screenshot(y) do bazy
                            <p class="text-xs mt-1 opacity-80">Mo≈ºesz wybraƒá wiele plik√≥w naraz!</p>
                        </label>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" multiple>
                    </div>

                    <div id="queueProgress" class="hidden mb-4 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-indigo-800">üì• Przetwarzanie</span>
                            <span class="text-indigo-600 font-bold" id="queueStatus">0 / 0</span>
                        </div>
                        <div class="w-full bg-indigo-200 rounded-full h-3 overflow-hidden">
                            <div id="queueBar" class="bg-indigo-600 h-3 rounded-full transition-all" style="width:0%"></div>
                        </div>
                        <p class="text-sm text-indigo-600 mt-2" id="queueInfo"></p>
                    </div>

                    <div id="progress" class="hidden mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl text-center">
                        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent mx-auto mb-2"></div>
                        <p id="progressText" class="text-blue-700 font-bold text-sm"></p>
                    </div>

                    <div id="errorBox" class="hidden mb-4 p-3 bg-red-50 border-2 border-red-200 rounded-xl">
                        <p class="text-red-700 text-sm font-bold">‚ö†Ô∏è <span id="errorText"></span></p>
                    </div>

                    <div class="mb-3 flex items-center justify-between">
                        <h3 class="text-sm font-bold text-gray-500">Zaznacz ‚Üí dodaj do koszyka</h3>
                        <span id="recipeCount" class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-bold">0</span>
                    </div>

                    <div id="recipesList" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-indigo-400 mx-auto mb-3"></div>
                            <p class="text-sm">≈Åadowanie...</p>
                        </div>
                    </div>
                </div>

                <div id="stickyBar" class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 p-4 hidden">
                    <div class="max-w-2xl mx-auto">
                        <button onclick="window.addSelectedToCart()"
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black py-4 rounded-2xl shadow-xl text-base hover:opacity-90 transition-all">
                            üß∫ Dodaj zaznaczone do koszyka (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            `;

            document.getElementById("imageInput").addEventListener("change", function(e) {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                processingQueue = files;
                document.getElementById("queueProgress").classList.remove("hidden");
                updateQueueProgress(0, files.length);
                processQueue();
            });

            updateCategoryCartBadge();
            renderMiniCounter();
            await loadCategoryRecipes();
        };

        async function loadCategoryRecipes() {
            try {
                const q = query(collection(db, "recipes"), where("category", "==", currentCategory.id));
                const snap = await getDocs(q);
                categoryRecipes = snap.docs.map(d => ({ firebaseId: d.id, ...d.data() }));
                renderCategoryRecipes();
            } catch(e) { showError("B≈ÇƒÖd ≈Çadowania: " + e.message); }
        }

        function renderCategoryRecipes() {
            const container = document.getElementById("recipesList");
            const countEl = document.getElementById("recipeCount");
            const stickyBar = document.getElementById("stickyBar");
            const selCount = document.getElementById("selectedCount");
            if (!container) return;
            if (countEl) countEl.textContent = categoryRecipes.length;
            if (stickyBar) { if (localSelected.size > 0) stickyBar.classList.remove("hidden"); else stickyBar.classList.add("hidden"); }
            if (selCount) selCount.textContent = localSelected.size;

            if (!categoryRecipes.length) {
                container.innerHTML = `<div class="text-center text-gray-400 py-10 border-2 border-dashed border-gray-200 rounded-xl"><div class="text-4xl mb-3">üì≠</div><p class="font-bold text-sm">Brak przepis√≥w</p><p class="text-xs mt-1">Dodaj screenshoty powy≈ºej!</p></div>`;
                return;
            }

            container.innerHTML = categoryRecipes.map(r => {
                const inCart = isInCart(r.firebaseId);
                const selected = localSelected.has(r.firebaseId);
                const targetKcal = customKcal[r.firebaseId];
                const displayRecipe = targetKcal ? scaleRecipe(r, targetKcal) : r;
                const hasKcal = !!r.macros?.calories;
                const remaining = getRemaining();

                return `
                <div class="rounded-xl border-2 overflow-hidden transition-all ${inCart ? 'border-green-400 bg-green-50' : selected ? 'border-indigo-400 bg-indigo-50 shadow-md' : 'border-gray-200 bg-white hover:border-gray-300'}">
                    <div onclick="window.toggleLocalSelect('${r.firebaseId}')" class="p-4 cursor-pointer">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-2">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <h3 class="font-bold text-gray-800 text-sm">${r.title}</h3>
                                    ${inCart ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">‚úì w koszyku</span>' : ''}
                                    ${targetKcal ? `<span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold">‚ö° ${targetKcal} kcal</span>` : ''}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">üìã ${r.ingredients?.length || 0} sk≈Çadnik√≥w</p>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <button onclick="window.deleteRecipe('${r.firebaseId}', event)" class="text-red-300 hover:text-red-500 transition-colors" title="Usu≈Ñ z bazy">üóëÔ∏è</button>
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs font-bold ${inCart ? 'bg-green-500 border-green-500 text-white' : selected ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-gray-300'}">${inCart || selected ? '‚úì' : ''}</div>
                            </div>
                        </div>
                        ${displayRecipe.macros ? `
                            <div class="mt-2 pt-2 border-t grid grid-cols-4 gap-1 text-xs">
                                <div class="bg-orange-100 p-1.5 rounded text-center"><div class="font-bold text-orange-700">${displayRecipe.macros.calories||0}</div><div class="text-orange-500">kcal</div></div>
                                <div class="bg-blue-100 p-1.5 rounded text-center"><div class="font-bold text-blue-700">${displayRecipe.macros.protein||0}g</div><div class="text-blue-500">B</div></div>
                                <div class="bg-green-100 p-1.5 rounded text-center"><div class="font-bold text-green-700">${displayRecipe.macros.carbs||0}g</div><div class="text-green-500">W</div></div>
                                <div class="bg-yellow-100 p-1.5 rounded text-center"><div class="font-bold text-yellow-700">${displayRecipe.macros.fat||0}g</div><div class="text-yellow-500">T</div></div>
                            </div>` : ''}
                    </div>
                    ${hasKcal ? `
                    <div class="px-4 pb-3">
                        <button onclick="window.adjustKcal('${r.firebaseId}', event)"
                            class="w-full text-xs font-bold py-2 px-3 rounded-lg transition-all ${targetKcal ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">
                            ‚ö° ${targetKcal ? `Zmie≈Ñ (${r.macros.calories} ‚Üí ${targetKcal} kcal)` : `Dostosuj kalorie (${r.macros.calories} kcal) ¬∑ zosta≈Ço ${remaining} kcal`}
                        </button>
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        window.toggleLocalSelect = function(firebaseId) {
            if (isInCart(firebaseId)) {
                cart = cart.filter(r => r.firebaseId !== firebaseId);
                updateCategoryCartBadge();
                renderMiniCounter();
                renderCategoryRecipes();
                return;
            }
            if (localSelected.has(firebaseId)) localSelected.delete(firebaseId);
            else localSelected.add(firebaseId);
            renderCategoryRecipes();
        };

        window.addSelectedToCart = function() {
            localSelected.forEach(id => {
                if (!isInCart(id)) {
                    const recipe = categoryRecipes.find(r => r.firebaseId === id);
                    if (!recipe) return;
                    const targetKcal = customKcal[id];
                    const finalRecipe = targetKcal ? scaleRecipe(recipe, targetKcal) : recipe;
                    cart.push({ ...finalRecipe, categoryId: currentCategory.id });
                }
            });
            localSelected.clear();
            renderCategoryRecipes();
            updateCategoryCartBadge();
            renderMiniCounter();
        };

        window.deleteRecipe = async function(firebaseId, event) {
            event.stopPropagation();
            if (!confirm("UsunƒÖƒá ten przepis z bazy?")) return;
            try {
                await deleteDoc(doc(db, "recipes", firebaseId));
                categoryRecipes = categoryRecipes.filter(r => r.firebaseId !== firebaseId);
                localSelected.delete(firebaseId);
                cart = cart.filter(r => r.firebaseId !== firebaseId);
                delete customKcal[firebaseId];
                renderCategoryRecipes();
                updateCategoryCartBadge();
                renderMiniCounter();
            } catch(e) { alert("B≈ÇƒÖd usuwania: " + e.message); }
        };

        // ‚îÄ‚îÄ WYNIKI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.goToResults = function() {
            if (!cart.length) { alert("Koszyk jest pusty!"); return; }

            const grouped = {};
            CATEGORIES.forEach(cat => { grouped[cat.id] = []; });
            cart.forEach(r => { if (grouped[r.categoryId]) grouped[r.categoryId].push(r); });

            const total = { calories:0, protein:0, carbs:0, fat:0 };
            let hasMacros = false;
            cart.forEach(r => {
                if (r.macros) { hasMacros=true; total.calories+=r.macros.calories||0; total.protein+=r.macros.protein||0; total.carbs+=r.macros.carbs||0; total.fat+=r.macros.fat||0; }
            });

            const remaining = getRemaining();
            const col = getProgressColor();
            const over = remaining < 0;

            document.getElementById("app").innerHTML = `
                <div class="max-w-2xl mx-auto p-4 pb-10">
                    <div class="flex items-center gap-3 mb-5 pt-4">
                        <button onclick="window.goHome()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold px-4 py-2 rounded-xl text-sm">‚Üê Wr√≥ƒá</button>
                        <h2 class="text-xl font-black text-gray-800">üõí Lista Zakup√≥w</h2>
                        <button onclick="window.copyFullList()" id="copyBtn" class="ml-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-4 py-2 rounded-xl text-sm">üìã Kopiuj</button>
                    </div>

                    <!-- Podsumowanie kalorii na g√≥rze wynik√≥w -->
                    <div class="mb-5 p-4 ${col.bg} border-2 rounded-2xl">
                        <div class="flex items-center justify-between mb-2">
                            <p class="font-black text-gray-800">üî• Podsumowanie kalorii dnia</p>
                            <p class="font-black text-2xl ${col.text}">${Math.round(total.calories)} kcal</p>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden mb-2">
                            <div class="${col.bar} h-3 rounded-full" style="width:${getProgressPct()}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Limit: <b>${dailyLimit} kcal</b></span>
                            <span>${over ? `<b class="text-red-600">‚ö†Ô∏è Przekroczono o ${Math.abs(remaining)} kcal</b>` : `<b class="${col.text}">Pozosta≈Ço: ${remaining} kcal</b>`}</span>
                        </div>
                    </div>

                    <!-- Lista zakup√≥w z podzia≈Çem -->
                    <div class="space-y-5 mb-6">
                        ${CATEGORIES.filter(cat => grouped[cat.id]?.length > 0).map(cat => `
                            <div class="rounded-2xl overflow-hidden border-2 ${cat.light}">
                                <div class="bg-gradient-to-r ${cat.color} text-white px-4 py-3 font-black text-base flex justify-between items-center">
                                    <span>${cat.emoji} ${cat.label}</span>
                                    <span class="text-sm font-bold opacity-90">${grouped[cat.id].reduce((s,r)=>s+(r.macros?.calories||0),0)} kcal</span>
                                </div>
                                <div class="p-3 space-y-4">
                                    ${grouped[cat.id].map((recipe, ri) => `
                                        ${ri > 0 ? '<div class="border-t border-gray-200"></div>' : ''}
                                        <div>
                                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                                <p class="font-bold text-gray-700 text-sm">üìã ${recipe.title}</p>
                                                ${recipe._scaled ? `<span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full font-bold">‚ö° ${recipe._targetKcal} kcal</span>` : ''}
                                                ${recipe.macros?.calories ? `<span class="text-xs text-gray-400 ml-auto">${recipe.macros.calories} kcal</span>` : ''}
                                            </div>
                                            <div class="space-y-1.5 pl-2">
                                                ${recipe.ingredients?.map(ing => `
                                                    <div class="flex items-center gap-2">
                                                        <button onclick="window.toggleIng(this)" class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center flex-shrink-0 hover:border-green-400 transition-colors text-xs font-bold"></button>
                                                        <span class="text-sm text-gray-700 ing-text">${ing}</span>
                                                    </div>
                                                `).join('') || ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${hasMacros ? `
                    <div class="rounded-2xl overflow-hidden border-2 border-orange-200 mb-6">
                        <div class="bg-gradient-to-r from-orange-400 to-red-500 text-white px-4 py-3 font-black">
                            üìä Makrosk≈Çadniki ‚Äî Suma wszystkich posi≈Çk√≥w
                        </div>
                        <div class="p-4">
                            <div class="bg-orange-50 rounded-xl p-4 text-center mb-3">
                                <div class="text-5xl font-black text-orange-600">${Math.round(total.calories)}</div>
                                <div class="text-sm text-orange-500 font-bold mt-1">KALORII RAZEM</div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <div class="bg-blue-50 border border-blue-200 p-3 rounded-xl text-center"><div class="text-2xl font-black text-blue-600">${Math.round(total.protein*10)/10}g</div><div class="text-xs text-blue-500 mt-1">üí™ Bia≈Çko</div></div>
                                <div class="bg-green-50 border border-green-200 p-3 rounded-xl text-center"><div class="text-2xl font-black text-green-600">${Math.round(total.carbs*10)/10}g</div><div class="text-xs text-green-500 mt-1">üçû Wƒôglowodany</div></div>
                                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-xl text-center"><div class="text-2xl font-black text-yellow-600">${Math.round(total.fat*10)/10}g</div><div class="text-xs text-yellow-500 mt-1">üßà T≈Çuszcze</div></div>
                            </div>
                            ${cart.filter(r=>r.macros).length > 1 ? `
                            <div class="border-t border-orange-200 pt-3">
                                <p class="text-xs font-bold text-gray-500 mb-2">Podzia≈Ç per przepis:</p>
                                ${cart.filter(r=>r.macros).map(r => {
                                    const cat = CATEGORIES.find(c=>c.id===r.categoryId);
                                    return `<div class="flex justify-between text-xs text-gray-600 py-1.5 border-b border-gray-100">
                                        <span>${cat?.emoji} ${r.title}${r._scaled?' ‚ö°':''}</span>
                                        <span class="font-bold">${r.macros.calories} kcal ¬∑ ${r.macros.protein}g B ¬∑ ${r.macros.carbs}g W ¬∑ ${r.macros.fat}g T</span>
                                    </div>`;
                                }).join('')}
                            </div>` : ''}
                        </div>
                    </div>` : ''}

                    <button onclick="window.clearCartAndHome()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-xl text-sm transition-all">
                        üóëÔ∏è Wyczy≈õƒá koszyk i zacznij od nowa
                    </button>
                </div>
            `;
        };

        window.toggleIng = function(btn) {
            const text = btn.parentElement.querySelector('.ing-text');
            if (btn.classList.contains('checked')) {
                btn.classList.remove('checked','bg-green-500','border-green-500','text-white');
                btn.textContent = '';
                if (text) { text.classList.remove('line-through','text-gray-400'); text.classList.add('text-gray-700'); }
            } else {
                btn.classList.add('checked','bg-green-500','border-green-500','text-white');
                btn.textContent = '‚úì';
                if (text) { text.classList.add('line-through','text-gray-400'); text.classList.remove('text-gray-700'); }
            }
        };

        window.copyFullList = async function() {
            let text = "üõí LISTA ZAKUP√ìW\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
            const grouped = {};
            CATEGORIES.forEach(cat => { grouped[cat.id] = []; });
            cart.forEach(r => { if (grouped[r.categoryId]) grouped[r.categoryId].push(r); });
            CATEGORIES.filter(cat => grouped[cat.id]?.length > 0).forEach(cat => {
                text += cat.emoji + " " + cat.label.toUpperCase() + "\n" + "‚îÄ".repeat(28) + "\n";
                grouped[cat.id].forEach(recipe => {
                    text += "  üìã " + recipe.title + (recipe._scaled ? " (‚ö°"+recipe._targetKcal+" kcal)" : "") + "\n";
                    recipe.ingredients?.forEach(ing => { text += "     ‚Ä¢ " + ing + "\n"; });
                    text += "\n";
                });
            });
            const total = { calories:0, protein:0, carbs:0, fat:0 };
            let hasMacros = false;
            cart.forEach(r => { if (r.macros) { hasMacros=true; total.calories+=r.macros.calories||0; total.protein+=r.macros.protein||0; total.carbs+=r.macros.carbs||0; total.fat+=r.macros.fat||0; } });
            if (hasMacros) {
                text += "üìä MAKROSK≈ÅADNIKI RAZEM\n" + "‚îÄ".repeat(28) + "\n";
                text += "üî• Kalorie: " + Math.round(total.calories) + " / " + dailyLimit + " kcal (pozosta≈Ço: " + getRemaining() + ")\n";
                text += "üí™ Bia≈Çko: " + Math.round(total.protein*10)/10 + "g\n";
                text += "üçû Wƒôglowodany: " + Math.round(total.carbs*10)/10 + "g\n";
                text += "üßà T≈Çuszcze: " + Math.round(total.fat*10)/10 + "g\n\n";
            }
            text += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nWygenerowano: " + new Date().toLocaleString('pl-PL') + "\nLista Zakup√≥w AI ü§ñ";
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.getElementById("copyBtn");
                if (btn) { btn.textContent="‚úÖ Skopiowano!"; btn.classList.replace("bg-indigo-500","bg-green-500"); setTimeout(()=>{ btn.textContent="üìã Kopiuj"; btn.classList.replace("bg-green-500","bg-indigo-500"); },2000); }
            } catch(e) { alert("B≈ÇƒÖd kopiowania"); }
        };

        window.clearCartAndHome = function() { if (confirm("Wyczy≈õciƒá koszyk?")) { cart=[]; renderHome(); } };

        // ‚îÄ‚îÄ OCR + GPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function processQueue() {
            if (isProcessing || processingQueue.length === 0) return;
            isProcessing = true;
            const total = processingQueue.length; let done = 0;
            while (processingQueue.length > 0) {
                const file = processingQueue.shift(); done++;
                updateQueueProgress(done, total);
                const qi = document.getElementById("queueInfo"); if (qi) qi.textContent = "Przetwarzanie: " + file.name;
                try { await processImage(file); if (processingQueue.length > 0) await sleep(500); } catch(e) { console.error(e); }
            }
            setTimeout(() => { const el=document.getElementById("queueProgress"); if(el) el.classList.add("hidden"); }, 2000);
            isProcessing = false;
            const inp = document.getElementById("imageInput"); if (inp) inp.value = "";
        }

        async function processImage(file) {
            showProgress("üîç OCR...");
            try {
                const { data: { text } } = await Tesseract.recognize(file, "pol+eng", {
                    logger: m => { if (m.status==="recognizing text") showProgress("üîç OCR: " + Math.round(m.progress*100) + "% ‚Äî " + file.name); }
                });
                if (!text || text.trim().length < 10) { showError("Pominiƒôto: " + file.name); await sleep(2000); hideProgress(); return; }
                showProgress("ü§ñ Analiza AI...");
                await processWithGPT(text, file.name);
            } catch(e) { showError("B≈ÇƒÖd (" + file.name + "): " + e.message); await sleep(3000); hideProgress(); }
        }

        async function processWithGPT(ocrText, filename) {
            const response = await fetch("/api/process-recipe", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ocrText}) });
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || "B≈ÇƒÖd serwera");
            if (!result.ingredients?.length) { showError("Pominiƒôto " + filename + ": brak sk≈Çadnik√≥w"); await sleep(2000); hideProgress(); return; }
            const recipeData = { title: result.title || filename || "Przepis " + recipeIdCounter++, ingredients: result.ingredients, macros: result.macros||null, category: currentCategory.id, createdAt: new Date().toISOString() };
            const docRef = await addDoc(collection(db, "recipes"), recipeData);
            categoryRecipes.push({ firebaseId: docRef.id, ...recipeData });
            hideProgress();
            renderCategoryRecipes();
        }

        window.goHome = function() { renderHome(); };

        // INIT
        renderHome();

        function showProgress(text) { const el=document.getElementById("progress"); if(el) el.classList.remove("hidden"); const t=document.getElementById("progressText"); if(t) t.textContent=text; const err=document.getElementById("errorBox"); if(err) err.classList.add("hidden"); }
        function hideProgress() { const el=document.getElementById("progress"); if(el) el.classList.add("hidden"); }
        function showError(text) { const el=document.getElementById("errorBox"); if(el) el.classList.remove("hidden"); const t=document.getElementById("errorText"); if(t) t.textContent=text; hideProgress(); }
        function updateQueueProgress(current, total) { const pct=total>0?(current/total)*100:0; const bar=document.getElementById("queueBar"); if(bar) bar.style.width=pct+"%"; const s=document.getElementById("queueStatus"); if(s) s.textContent=current+" / "+total; }
        function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center text-gray-400">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-400 border-t-transparent mx-auto mb-4"></div>
                <p>≈Åadowanie aplikacji...</p>
            </div>
        </div>
    </div>
</body>
</html>
