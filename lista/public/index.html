<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista Zakup√≥w AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =============================================
        // FIREBASE CONFIG
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxS26DGBLPz24OF0V9fZ-99RGQA41hJtE",
            authDomain: "lista-zakupow-3f33b.firebaseapp.com",
            projectId: "lista-zakupow-3f33b",
            storageBucket: "lista-zakupow-3f33b.firebasestorage.app",
            messagingSenderId: "556246362684",
            appId: "1:556246362684:web:e3a17e4a330cc979e83139"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // =============================================
        // KATEGORIE
        // =============================================
        const CATEGORIES = [
            { id: "sniadania",         label: "≈öniadania",          emoji: "üåÖ", color: "from-amber-400 to-orange-400" },
            { id: "drugie_sniadania",  label: "Drugie ≈öniadania",   emoji: "ü•™", color: "from-lime-400 to-green-400" },
            { id: "obiady",            label: "Obiady",             emoji: "üç≤", color: "from-blue-400 to-indigo-400" },
            { id: "kolacje",           label: "Kolacje",            emoji: "üåô", color: "from-purple-400 to-pink-400" },
            { id: "dodatkowy_posilek", label: "Dodatkowy Posi≈Çek",  emoji: "üçé", color: "from-rose-400 to-red-400" },
        ];

        // =============================================
        // STAN APLIKACJI
        // =============================================
        let currentView = "home";          // "home" | "category" | "add"
        let currentCategory = null;
        let categoryRecipes = [];          // przepisy z Firebase dla aktywnej kategorii
        let selectedRecipes = new Set();
        let shoppingList = [];
        let isProcessing = false;
        let processingQueue = [];
        let recipeIdCounter = 1;

        // =============================================
        // INIT
        // =============================================
        window.addEventListener("DOMContentLoaded", () => {
            renderHome();
        });

        // =============================================
        // WIDOK: STRONA G≈Å√ìWNA (kategorie)
        // =============================================
        function renderHome() {
            currentView = "home";
            currentCategory = null;
            selectedRecipes.clear();
            shoppingList = [];

            document.getElementById("app").innerHTML = `
                <div class="max-w-2xl mx-auto p-4 pb-10">
                    <div class="text-center mb-8 pt-6">
                        <div class="text-5xl mb-3">üõí</div>
                        <h1 class="text-3xl font-black text-gray-800 tracking-tight">Lista Zakup√≥w AI</h1>
                        <p class="text-gray-500 mt-1">Wybierz kategoriƒô posi≈Çku</p>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${CATEGORIES.map(cat => `
                            <button onclick="window.openCategory('${cat.id}')"
                                class="group relative overflow-hidden bg-gradient-to-r ${cat.color} text-white font-bold py-6 px-6 rounded-2xl shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 text-left">
                                <div class="flex items-center gap-4">
                                    <span class="text-4xl">${cat.emoji}</span>
                                    <div>
                                        <div class="text-xl font-black">${cat.label}</div>
                                        <div class="text-sm opacity-80 font-normal" id="count-${cat.id}">≈Åadowanie...</div>
                                    </div>
                                </div>
                                <div class="absolute right-6 top-1/2 -translate-y-1/2 text-3xl opacity-30 group-hover:opacity-60 transition-opacity">‚Ä∫</div>
                            </button>
                        `).join("")}
                    </div>
                </div>
            `;

            // Za≈Çaduj liczniki
            CATEGORIES.forEach(cat => loadCategoryCount(cat));
        }

        async function loadCategoryCount(cat) {
            try {
                const q = query(collection(db, "recipes"), where("category", "==", cat.id));
                const snap = await getDocs(q);
                const el = document.getElementById(`count-${cat.id}`);
                if (el) el.textContent = `${snap.size} przepis√≥w`;
            } catch (e) {
                const el = document.getElementById(`count-${cat.id}`);
                if (el) el.textContent = "b≈ÇƒÖd ≈Çadowania";
            }
        }

        // =============================================
        // WIDOK: KATEGORIA (lista przepis√≥w)
        // =============================================
        window.openCategory = async function(categoryId) {
            currentCategory = CATEGORIES.find(c => c.id === categoryId);
            currentView = "category";
            selectedRecipes.clear();
            shoppingList = [];

            document.getElementById("app").innerHTML = `
                <div class="max-w-2xl mx-auto p-4 pb-10">
                    <div class="flex items-center gap-3 mb-6 pt-4">
                        <button onclick="window.goHome()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold px-4 py-2 rounded-xl transition-all">‚Üê Wr√≥ƒá</button>
                        <div>
                            <h2 class="text-2xl font-black text-gray-800">${currentCategory.emoji} ${currentCategory.label}</h2>
                        </div>
                    </div>

                    <!-- Dodaj przepisy -->
                    <div class="mb-6">
                        <label for="imageInput"
                            class="block w-full bg-gradient-to-r ${currentCategory.color} text-white font-bold py-4 px-6 rounded-xl text-center cursor-pointer shadow-md hover:opacity-90 transition-all">
                            <span class="text-2xl mr-2">üì∏</span> Dodaj screenshot(y) do kategorii
                            <p class="text-xs mt-1 opacity-80">Mo≈ºesz wybraƒá wiele plik√≥w naraz!</p>
                        </label>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" multiple>
                    </div>

                    <!-- Queue Progress -->
                    <div id="queueProgress" class="hidden mb-4 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-indigo-800">üì• Przetwarzanie</span>
                            <span class="text-indigo-600 font-bold" id="queueStatus">0 / 0</span>
                        </div>
                        <div class="w-full bg-indigo-200 rounded-full h-3 overflow-hidden">
                            <div id="queueBar" class="bg-indigo-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-indigo-600 mt-2" id="queueInfo">Przetwarzanie...</p>
                    </div>

                    <div id="progress" class="hidden mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl text-center">
                        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent mx-auto mb-2"></div>
                        <p id="progressText" class="text-blue-700 font-bold"></p>
                    </div>

                    <div id="error" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl">
                        <p class="text-red-700 font-bold">‚ö†Ô∏è <span id="errorText"></span></p>
                    </div>

                    <!-- Lista przepis√≥w -->
                    <div class="mb-4 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-700">Przepisy w kategorii</h3>
                        <span id="recipeCount" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-bold">0</span>
                    </div>
                    <div id="recipesList" class="space-y-3 mb-6">
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-2">‚è≥</div>
                            <p>≈Åadowanie przepis√≥w...</p>
                        </div>
                    </div>

                    <!-- Generuj listƒô -->
                    <button id="generateBtn" onclick="window.generateShoppingList()" disabled
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl mb-6 shadow-lg disabled:opacity-40 transition-all">
                        üõí Wygeneruj Listƒô Zakup√≥w z zaznaczonych
                    </button>

                    <!-- Wyniki -->
                    <div id="resultsSection" class="hidden">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-xl font-bold text-gray-800">üõí Lista Zakup√≥w</h3>
                                    <button id="copyBtn" onclick="window.copyShoppingList()"
                                        class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-4 py-2 rounded-lg text-sm transition-all">
                                        üìã Kopiuj
                                    </button>
                                </div>
                                <div id="shoppingList" class="bg-gray-50 rounded-xl p-4"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-3">üìä Makrosk≈Çadniki</h3>
                                <div id="macrosSummary" class="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-xl p-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Event listener dla plik√≥w
            document.getElementById("imageInput").addEventListener("change", function(e) {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                processingQueue = files;
                document.getElementById("queueProgress").classList.remove("hidden");
                updateQueueProgress(0, files.length);
                processQueue();
            });

            // Za≈Çaduj przepisy z Firebase
            await loadCategoryRecipes();
        };

        async function loadCategoryRecipes() {
            try {
                const q = query(collection(db, "recipes"), where("category", "==", currentCategory.id));
                const snap = await getDocs(q);
                categoryRecipes = snap.docs.map(d => ({ firebaseId: d.id, ...d.data() }));
                renderRecipes();
            } catch (e) {
                showError("B≈ÇƒÖd ≈Çadowania przepis√≥w: " + e.message);
            }
        }

        function renderRecipes() {
            const container = document.getElementById("recipesList");
            const countEl = document.getElementById("recipeCount");
            if (!container) return;

            if (countEl) countEl.textContent = categoryRecipes.length;

            if (!categoryRecipes.length) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-10 border-2 border-dashed border-gray-200 rounded-xl">
                        <div class="text-5xl mb-3">üì≠</div>
                        <p class="font-bold">Brak przepis√≥w w tej kategorii</p>
                        <p class="text-sm mt-1">Dodaj screenshoty powy≈ºej!</p>
                    </div>
                `;
                document.getElementById("generateBtn").disabled = true;
                return;
            }

            container.innerHTML = categoryRecipes.map(r => `
                <div onclick="window.toggleRecipe('${r.firebaseId}')"
                    class="p-4 rounded-xl border-2 cursor-pointer transition-all ${selectedRecipes.has(r.firebaseId) ? `border-indigo-500 bg-indigo-50 shadow-md` : `border-gray-200 bg-white hover:border-gray-300`}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${r.title}</h3>
                            <p class="text-sm text-gray-500 mt-1">üìã ${r.ingredients?.length || 0} sk≈Çadnik√≥w</p>
                        </div>
                        <div class="flex items-center gap-2 ml-3">
                            <button onclick="window.deleteRecipe('${r.firebaseId}', event)"
                                class="text-red-400 hover:text-red-600 text-lg transition-colors" title="Usu≈Ñ">üóëÔ∏è</button>
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${selectedRecipes.has(r.firebaseId) ? `bg-indigo-500 border-indigo-500 text-white` : `border-gray-300`}">
                                ${selectedRecipes.has(r.firebaseId) ? "‚úì" : ""}
                            </div>
                        </div>
                    </div>
                    ${r.macros ? `
                        <div class="mt-3 pt-3 border-t grid grid-cols-4 gap-2 text-xs">
                            <div class="bg-orange-100 p-2 rounded text-center">
                                <div class="font-bold text-orange-700">${r.macros.calories || 0}</div>
                                <div class="text-orange-600">kcal</div>
                            </div>
                            <div class="bg-blue-100 p-2 rounded text-center">
                                <div class="font-bold text-blue-700">${r.macros.protein || 0}g</div>
                                <div class="text-blue-600">B</div>
                            </div>
                            <div class="bg-green-100 p-2 rounded text-center">
                                <div class="font-bold text-green-700">${r.macros.carbs || 0}g</div>
                                <div class="text-green-600">W</div>
                            </div>
                            <div class="bg-yellow-100 p-2 rounded text-center">
                                <div class="font-bold text-yellow-700">${r.macros.fat || 0}g</div>
                                <div class="text-yellow-600">T</div>
                            </div>
                        </div>
                    ` : `<p class="text-xs text-gray-400 mt-2">Brak makrosk≈Çadnik√≥w</p>`}
                </div>
            `).join("");

            document.getElementById("generateBtn").disabled = selectedRecipes.size === 0;
        }

        // =============================================
        // TOGGLE / DELETE
        // =============================================
        window.toggleRecipe = function(firebaseId) {
            if (selectedRecipes.has(firebaseId)) {
                selectedRecipes.delete(firebaseId);
            } else {
                selectedRecipes.add(firebaseId);
            }
            renderRecipes();
        };

        window.deleteRecipe = async function(firebaseId, event) {
            event.stopPropagation();
            if (!confirm("Czy na pewno usunƒÖƒá ten przepis z bazy?")) return;
            try {
                await deleteDoc(doc(db, "recipes", firebaseId));
                categoryRecipes = categoryRecipes.filter(r => r.firebaseId !== firebaseId);
                selectedRecipes.delete(firebaseId);
                renderRecipes();
            } catch (e) {
                alert("B≈ÇƒÖd usuwania: " + e.message);
            }
        };

        // =============================================
        // PRZETWARZANIE OCR + GPT
        // =============================================
        async function processQueue() {
            if (isProcessing || processingQueue.length === 0) return;
            isProcessing = true;
            const total = processingQueue.length;
            let done = 0;

            while (processingQueue.length > 0) {
                const file = processingQueue.shift();
                done++;
                updateQueueProgress(done, total);
                document.getElementById("queueInfo").textContent = `Przetwarzanie: ${file.name}`;
                try {
                    await processImage(file);
                    if (processingQueue.length > 0) await sleep(500);
                } catch (e) {
                    console.error(e);
                }
            }

            setTimeout(() => {
                const el = document.getElementById("queueProgress");
                if (el) el.classList.add("hidden");
            }, 2000);

            isProcessing = false;
            const inp = document.getElementById("imageInput");
            if (inp) inp.value = "";
        }

        async function processImage(file) {
            showProgress("üîç OCR...");
            try {
                const { data: { text } } = await Tesseract.recognize(file, "pol+eng", {
                    logger: m => {
                        if (m.status === "recognizing text") {
                            showProgress(`üîç OCR: ${Math.round(m.progress * 100)}% ‚Äî ${file.name}`);
                        }
                    }
                });

                if (!text || text.trim().length < 10) {
                    showError(`Pominiƒôto: ${file.name} (brak tekstu)`);
                    await sleep(2000);
                    hideProgress();
                    return;
                }

                showProgress("ü§ñ Analiza AI...");
                await processWithGPT(text, file.name);
            } catch (e) {
                showError(`B≈ÇƒÖd (${file.name}): ${e.message}`);
                await sleep(3000);
                hideProgress();
            }
        }

        async function processWithGPT(ocrText, filename = "") {
            const response = await fetch("/api/process-recipe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ocrText })
            });

            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || "B≈ÇƒÖd serwera");
            if (!result.ingredients?.length) {
                showError(`Pominiƒôto ${filename}: brak sk≈Çadnik√≥w`);
                await sleep(2000);
                hideProgress();
                return;
            }

            // Zapisz do Firebase
            const recipeData = {
                title: result.title || filename || `Przepis ${recipeIdCounter++}`,
                ingredients: result.ingredients,
                macros: result.macros || null,
                category: currentCategory.id,
                createdAt: new Date().toISOString()
            };

            const docRef = await addDoc(collection(db, "recipes"), recipeData);
            categoryRecipes.push({ firebaseId: docRef.id, ...recipeData });
            hideProgress();
            renderRecipes();
        }

        // =============================================
        // LISTA ZAKUP√ìW
        // =============================================
        window.generateShoppingList = function() {
            const selected = categoryRecipes.filter(r => selectedRecipes.has(r.firebaseId));
            const map = new Map();

            selected.forEach(r => {
                r.ingredients?.forEach(ing => {
                    const norm = ing.toLowerCase().trim();
                    let found = false;
                    for (let [key] of map.entries()) {
                        const b1 = key.toLowerCase().replace(/\d+\s*(g|ml|kg|szt)/gi, "").trim();
                        const b2 = norm.replace(/\d+\s*(g|ml|kg|szt)/gi, "").trim();
                        if (b1 === b2 || b1.includes(b2) || b2.includes(b1)) {
                            map.set(key, (map.get(key) || 1) + 1);
                            found = true;
                            break;
                        }
                    }
                    if (!found) map.set(ing, 1);
                });
            });

            shoppingList = Array.from(map.entries()).map(([name, count], i) => ({
                id: i,
                name: count > 1 ? `${name} (x${count})` : name,
                checked: false
            }));

            document.getElementById("resultsSection").classList.remove("hidden");
            renderShoppingList();
            renderMacrosSummary();
        };

        function renderShoppingList() {
            const container = document.getElementById("shoppingList");
            if (!shoppingList.length) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Brak produkt√≥w</p>';
                return;
            }
            const left = shoppingList.filter(i => !i.checked).length;
            container.innerHTML = `
                <div class="space-y-2">
                    ${shoppingList.map(item => `
                        <div class="flex items-center gap-3 p-3 rounded-lg ${item.checked ? "bg-green-100 line-through text-green-700" : "bg-white"} shadow-sm">
                            <button onclick="window.toggleItem(${item.id})"
                                class="w-6 h-6 rounded border-2 flex items-center justify-center flex-shrink-0 ${item.checked ? "bg-green-500 border-green-500 text-white" : "border-gray-400"}">
                                ${item.checked ? "‚úì" : ""}
                            </button>
                            <span class="flex-1">${item.name}</span>
                        </div>
                    `).join("")}
                </div>
                <div class="mt-4 pt-3 border-t text-center font-bold text-gray-600">
                    üõí ${left} / ${shoppingList.length} do kupienia
                </div>
            `;
        }

        function renderMacrosSummary() {
            const container = document.getElementById("macrosSummary");
            const selected = categoryRecipes.filter(r => selectedRecipes.has(r.firebaseId));
            const total = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            let hasAny = false;

            selected.forEach(r => {
                if (r.macros) {
                    hasAny = true;
                    total.calories += r.macros.calories || 0;
                    total.protein += r.macros.protein || 0;
                    total.carbs += r.macros.carbs || 0;
                    total.fat += r.macros.fat || 0;
                }
            });

            if (!hasAny) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Brak danych makro</p>';
                return;
            }

            container.innerHTML = `
                <div class="space-y-3">
                    <div class="bg-gradient-to-r from-orange-400 to-red-400 text-white p-4 rounded-xl text-center">
                        <div class="text-4xl font-black">${total.calories}</div>
                        <div class="text-sm opacity-90">KALORII RAZEM</div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-blue-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-blue-700">${total.protein}g</div>
                            <div class="text-xs text-blue-600">üí™ Bia≈Çko</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-green-700">${total.carbs}g</div>
                            <div class="text-xs text-green-600">üçû Wƒôgle</div>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-yellow-700">${total.fat}g</div>
                            <div class="text-xs text-yellow-600">üßà T≈Çuszcz</div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.toggleItem = function(id) {
            const item = shoppingList.find(i => i.id === id);
            if (item) { item.checked = !item.checked; renderShoppingList(); }
        };

        window.copyShoppingList = async function() {
            let text = "üõí LISTA ZAKUP√ìW\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
            const unchecked = shoppingList.filter(i => !i.checked);
            const checked = shoppingList.filter(i => i.checked);
            if (unchecked.length) {
                text += "üìã DO KUPIENIA:\n";
                unchecked.forEach((item, i) => { text += `${i + 1}. ${item.name}\n`; });
                text += "\n";
            }
            if (checked.length) {
                text += "‚úÖ KUPIONE:\n";
                checked.forEach((item, i) => { text += `${i + 1}. ${item.name}\n`; });
            }
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.getElementById("copyBtn");
                btn.textContent = "‚úÖ Skopiowano!";
                btn.classList.replace("bg-indigo-500", "bg-green-500");
                setTimeout(() => {
                    btn.textContent = "üìã Kopiuj";
                    btn.classList.replace("bg-green-500", "bg-indigo-500");
                }, 2000);
            } catch (e) {
                alert("B≈ÇƒÖd kopiowania");
            }
        };

        // =============================================
        // NAWIGACJA
        // =============================================
        window.goHome = function() { renderHome(); };

        // =============================================
        // HELPERS
        // =============================================
        function showProgress(text) {
            const el = document.getElementById("progress");
            const txt = document.getElementById("progressText");
            if (el) el.classList.remove("hidden");
            if (txt) txt.textContent = text;
            const err = document.getElementById("error");
            if (err) err.classList.add("hidden");
        }

        function hideProgress() {
            const el = document.getElementById("progress");
            if (el) el.classList.add("hidden");
        }

        function showError(text) {
            const el = document.getElementById("error");
            const txt = document.getElementById("errorText");
            if (el) el.classList.remove("hidden");
            if (txt) txt.textContent = text;
            hideProgress();
        }

        function updateQueueProgress(current, total) {
            const pct = total > 0 ? (current / total) * 100 : 0;
            const bar = document.getElementById("queueBar");
            const status = document.getElementById("queueStatus");
            if (bar) bar.style.width = pct + "%";
            if (status) status.textContent = `${current} / ${total}`;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center text-gray-400">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-400 border-t-transparent mx-auto mb-4"></div>
                <p>≈Åadowanie aplikacji...</p>
            </div>
        </div>
    </div>
</body>
</html>
